<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Criativo - Pedrad Ads</title>
  <style>
    :root{--bg:#000;--card:#0a0a0a;--input:#171717;--text:#fff;--muted:#737373;--border:#262626;--primary:#00d9ff;--danger:#ef4444;--success:#22c55e;--radius:12px}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);padding:20px}
    .container{max-width:900px;margin:0 auto}
    .header{margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid var(--primary)}
    h1{font-size:1.5rem;font-weight:700;margin-bottom:8px}
    .steps{display:flex;gap:12px;margin-bottom:24px}
    .step{flex:1;padding:12px;text-align:center;border:1px solid var(--border);border-radius:10px;background:var(--input)}
    .step.active{background:var(--primary);color:#000}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px}
    .form-group{margin-bottom:20px}
    label{display:block;margin-bottom:8px;color:var(--muted);font-size:.9rem;font-weight:600}
    input,textarea,select{width:100%;padding:12px;background:var(--input);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:.95rem}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--primary)}
    textarea{resize:vertical;min-height:100px}
    .upload-area{border:2px dashed var(--border);border-radius:10px;padding:40px;text-align:center;cursor:pointer;transition:.2s}
    .upload-area:hover{border-color:var(--primary)}
    .upload-area.has-file{border-color:var(--success);background:rgba(34,197,94,.1)}
    .preview-img{max-width:100%;max-height:300px;margin-top:16px;border-radius:8px}
    .product-select{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-top:12px}
    .product-option{padding:12px;border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:.2s}
    .product-option:hover{border-color:var(--primary)}
    .product-option.selected{background:var(--primary);color:#000;border-color:var(--primary)}
    .btn{padding:12px 24px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer;font-size:.95rem;transition:.2s}
    .btn:hover{background:var(--primary);color:#000}
    .btn-primary{background:var(--primary);color:#000}
    .summary{background:var(--input);padding:18px;border-radius:10px}
    .summary-line{display:flex;justify-content:space-between;margin-bottom:8px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Upload Criativo</h1>
      <div style="color:var(--muted);font-size:.9rem">Configure seu an√∫ncio</div>
    </div>

    <div class="steps">
      <div class="step">1. Selecionar Hor√°rios</div>
      <div class="step active">2. Upload Criativo</div>
      <div class="step">3. Pagamento</div>
    </div>

    <div class="card">
      <h2 style="font-size:1.1rem;margin-bottom:20px">Imagem do An√∫ncio</h2>
      
      <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
        <div>üì∑ Clique ou arraste uma imagem</div>
        <div style="color:var(--muted);font-size:.85rem;margin-top:8px">JPG, PNG (m√°x 2MB)</div>
        <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleFile(event)">
        <img id="preview" class="preview-img" style="display:none">
      </div>
    </div>

    <div class="card">
      <h2 style="font-size:1.1rem;margin-bottom:20px">Descri√ß√£o do An√∫ncio</h2>
      <div class="form-group">
        <textarea id="descricao" placeholder="Descreva seu produto ou servi√ßo..."></textarea>
      </div>
    </div>

    <div class="card">
      <h2 style="font-size:1.1rem;margin-bottom:12px">Produto Vinculado (Opcional)</h2>
      <p style="color:var(--muted);font-size:.85rem;margin-bottom:16px">Selecione um produto da sua loja para vincular ao an√∫ncio</p>
      
      <div id="productsLoading" style="text-align:center;padding:20px;color:var(--muted)">Carregando produtos...</div>
      <div id="productsList" class="product-select" style="display:none"></div>

      <div class="form-group" id="priceField" style="display:none;margin-top:20px">
        <label>Pre√ßo do Produto (R$)</label>
        <input type="number" id="productPrice" step="0.01" placeholder="0.00">
      </div>
    </div>

    <div class="summary">
      <div class="summary-line">
        <span>Servi√ßo:</span>
        <span id="serviceInfo">-</span>
      </div>
      <div class="summary-line">
        <span>Slots:</span>
        <span id="slotsInfo">-</span>
      </div>
    </div>

    <div style="display:flex;gap:12px;margin-top:20px">
      <button class="btn" onclick="window.location.href='Step1.html'">‚Üê Voltar</button>
      <button class="btn btn-primary" onclick="nextStep()" style="flex:1">Pr√≥ximo: Pagamento ‚Üí</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAnIJRcUxN-0swpVnonPbJjTSK87o4CQ_g",
      authDomain: "pedrad-814d0.firebaseapp.com",
      projectId: "pedrad-814d0",
      storageBucket: "pedrad-814d0.appspot.com",
      messagingSenderId: "293587190550",
      appId: "1:293587190550:web:80c9399f82847c80e20637"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let uploadedImage = null;
    let selectedProductId = null;
    let storeProducts = [];
    let currentUser = null;

    async function init() {
      currentUser = auth.currentUser || await new Promise(r => auth.onAuthStateChanged(u => r(u)));
      if (!currentUser) {
        alert('Fa√ßa login');
        return;
      }

      const itemId = localStorage.getItem('pedrad_selected_item');
      const slots = JSON.parse(localStorage.getItem('pedrad_campaign_slots') || '[]');
      
      if (!itemId || !slots.length) {
        window.location.href = 'adsShop.html';
        return;
      }

      await loadServiceInfo(itemId);
      document.getElementById('slotsInfo').textContent = `${slots.length} selecionado(s)`;
      await loadStoreProducts();
    }

    async function loadServiceInfo(itemId) {
      try {
        const doc = await db.collection('ads_shop_items').doc(itemId).get();
        const item = doc.data();
        document.getElementById('serviceInfo').textContent = item.nome;
      } catch (e) {
        console.error(e);
      }
    }



async function loadStoreProducts() {
  try {
    const storeId = localStorage.getItem('currentStoreId') || localStorage.getItem('CURRENT_STORE_ID');
    
    if (!storeId) {
      document.getElementById('productsLoading').innerHTML = 'Loja n√£o identificada';
      return;
    }

    const snapshot = await db.collection('products')
      .where('storeId', '==', storeId)
      .where('active', '==', true)
      .limit(20)
      .get();

    storeProducts = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

    if (storeProducts.length === 0) {
      document.getElementById('productsLoading').innerHTML = 'Nenhum produto dispon√≠vel';
      return;
    }

    document.getElementById('productsLoading').style.display = 'none';
    document.getElementById('productsList').style.display = 'grid';

    document.getElementById('productsList').innerHTML = storeProducts.map(p => `
      <div class="product-option" onclick="selectProduct('${p.id}')">
        <div style="font-weight:700;margin-bottom:4px">${p.name}</div>
        <div style="font-size:.85rem;color:var(--muted)">R$ ${p.price.toFixed(2)}</div>
      </div>
    `).join('');

  } catch (e) {
    console.error(e);
    document.getElementById('productsLoading').innerHTML = 'Erro ao carregar';
  }
}

    function selectProduct(id) {
      selectedProductId = id;
      document.querySelectorAll('.product-option').forEach(el => el.classList.remove('selected'));
      event.target.closest('.product-option').classList.add('selected');
      
      const product = storeProducts.find(p => p.id === id);
      document.getElementById('productPrice').value = product.price.toFixed(2);
      document.getElementById('priceField').style.display = 'block';
    }

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 2 * 1024 * 1024) return alert('Imagem muito grande (m√°x 2MB)');

      const reader = new FileReader();
      reader.onload = (ev) => {
        uploadedImage = ev.target.result;
        document.getElementById('preview').src = uploadedImage;
        document.getElementById('preview').style.display = 'block';
        document.getElementById('uploadArea').classList.add('has-file');
      };
      reader.readAsDataURL(file);
    }

    function nextStep() {
      if (!uploadedImage) return alert('Adicione uma imagem');
      if (!document.getElementById('descricao').value.trim()) return alert('Adicione uma descri√ß√£o');

      const campaignData = {
        itemId: localStorage.getItem('pedrad_selected_item'),
        slots: JSON.parse(localStorage.getItem('pedrad_campaign_slots')),
        criativo: {
          imageBase64: uploadedImage,
          descricao: document.getElementById('descricao').value
        },
        produto: selectedProductId ? {
          id: selectedProductId,
          valor: parseFloat(document.getElementById('productPrice').value) || 0
        } : null,
        userId: currentUser.uid,
        createdAt: new Date().toISOString()
      };

      localStorage.setItem('pedrad_campaign_data', JSON.stringify(campaignData));
      window.location.href = 'Step3.html';
    }

    init();
  </script>
</body>
</html>
