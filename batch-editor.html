<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro em Lote - Pedrad</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', -apple-system, sans-serif; background: #0a0a14; color: #e0e0e0; min-height: 100vh; }
        .header { background: #12121f; border-bottom: 1px solid #1e1e35; padding: 16px 24px; display: flex; align-items: center; gap: 14px; position: sticky; top: 0; z-index: 50; }
        .header h1 { font-size: 1.1rem; font-weight: 600; color: #a78bfa; display: flex; align-items: center; gap: 8px; }
        .header .store-tag { font-size: .75rem; background: #1e1e35; color: #888; padding: 4px 10px; border-radius: 20px; margin-left: auto; }
        .container { max-width: 560px; margin: 0 auto; padding: 24px 16px 100px; }
        .steps { display: flex; gap: 8px; margin-bottom: 28px; }
        .step-dot { flex: 1; height: 4px; border-radius: 2px; background: #1e1e35; transition: background .3s; }
        .step-dot.active { background: #a78bfa; }
        .step-dot.done { background: #10b981; }
        .card { background: #12121f; border: 1px solid #1e1e35; border-radius: 12px; padding: 24px; margin-bottom: 16px; }
        .card-title { font-size: .85rem; color: #888; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px; }
        .field { margin-bottom: 16px; }
        .field label { display: block; font-size: .8rem; color: #666; margin-bottom: 6px; }
        .field input, .field select { width: 100%; padding: 12px 14px; background: #0a0a14; border: 1px solid #2a2a45; border-radius: 8px; color: #e0e0e0; font-size: .95rem; outline: none; transition: border-color .2s; }
        .field input:focus, .field select:focus { border-color: #a78bfa; }
        .field input::placeholder { color: #444; }
        .field select option { background: #0a0a14; }
        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .name-box { background: #0a0a14; border: 2px dashed #a78bfa40; border-radius: 12px; padding: 24px 20px; text-align: center; margin-bottom: 20px; transition: border-color .3s; }
        .name-box.active { border-color: #a78bfa; }
        .name-box .counter { font-size: .8rem; color: #a78bfa; margin-bottom: 12px; }
        .name-box input { width: 100%; padding: 14px; background: #12121f; border: 1px solid #2a2a45; border-radius: 8px; color: #e0e0e0; font-size: 1.1rem; text-align: center; outline: none; }
        .name-box input:focus { border-color: #a78bfa; }
        .name-box input::placeholder { color: #444; }
        .name-box .hint { font-size: .7rem; color: #555; margin-top: 8px; }
        .items-header { font-size: .8rem; color: #888; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .items-list { list-style: none; max-height: 260px; overflow-y: auto; margin-bottom: 20px; }
        .items-list::-webkit-scrollbar { width: 4px; }
        .items-list::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        .item-row { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: #0a0a14; border-radius: 8px; margin-bottom: 6px; font-size: .88rem; }
        .item-row:hover { background: #0f0f1e; }
        .item-num { color: #555; font-size: .75rem; min-width: 22px; }
        .item-name { flex: 1; }
        .item-name strong { color: #a78bfa; }
        .item-row input { flex: 1; background: #12121f; border: 1px solid #a78bfa; border-radius: 4px; color: #e0e0e0; padding: 4px 8px; font-size: .88rem; outline: none; }
        .icon-btn { background: none; border: none; cursor: pointer; padding: 4px 6px; border-radius: 4px; font-size: .85rem; }
        .icon-btn:hover { background: #1e1e35; }
        .icon-btn.edit { color: #60a5fa; }
        .icon-btn.del { color: #f87171; }
        .icon-btn.save { color: #34d399; }
        .actions { display: flex; gap: 10px; justify-content: flex-end; }
        .btn { padding: 11px 22px; border: none; border-radius: 8px; cursor: pointer; font-size: .9rem; font-weight: 600; transition: all .2s; }
        .btn:hover { filter: brightness(1.1); }
        .btn:disabled { opacity: .4; cursor: not-allowed; }
        .btn-primary { background: #a78bfa; color: #0a0a14; }
        .btn-success { background: #10b981; color: #fff; }
        .btn-ghost { background: #1e1e35; color: #aaa; }
        .status-msg { text-align: center; font-size: .85rem; min-height: 24px; margin-top: 12px; }
        .status-msg.ok { color: #34d399; }
        .status-msg.error { color: #f87171; }
        .status-msg.info { color: #60a5fa; }
        .done-banner { text-align: center; padding: 20px; color: #34d399; font-weight: 600; }
        .price-toggle { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
        .price-toggle label { margin: 0; font-size: .85rem; color: #aaa; }
        .toggle { position: relative; width: 40px; height: 22px; cursor: pointer; }
        .toggle input { display: none; }
        .toggle .slider { position: absolute; inset: 0; background: #2a2a45; border-radius: 11px; transition: background .2s; }
        .toggle .slider::after { content: ''; position: absolute; width: 16px; height: 16px; left: 3px; top: 3px; background: #888; border-radius: 50%; transition: all .2s; }
        .toggle input:checked + .slider { background: #a78bfa; }
        .toggle input:checked + .slider::after { left: 21px; background: #fff; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üì¶ Cadastro em Lote</h1>
        <span class="store-tag" id="storeTag">Loja: ...</span>
    </div>
    <div class="container">
        <div class="steps">
            <div class="step-dot" id="step1"></div>
            <div class="step-dot" id="step2"></div>
            <div class="step-dot" id="step3"></div>
        </div>
        <div id="content"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
    (() => {
        const db = firebase.firestore();
        const params = new URLSearchParams(window.location.search);
        const storeId = params.get('storeId') || localStorage.getItem('currentStoreId');

        if (!storeId) {
            document.getElementById('content').innerHTML = '<div class="done-banner" style="color:#f87171;">‚ùå storeId n√£o encontrado.</div>';
            return;
        }
        document.getElementById('storeTag').textContent = `ID: ${storeId.substring(0,12)}‚Ä¶`;

        let categories = [];
        let state = { marca:'', tipo:'', quantidade:0, price:'', usePrice:false, category:'', items:[], currentIndex:0, editingId:null, step:1 };
        let idCounter = 0;

        // ‚îÄ‚îÄ Load categories ‚îÄ‚îÄ
        async function loadCategories() {
            try {
                const storeDoc = await db.collection('stores').doc(storeId).get();
                const sd = storeDoc.exists ? storeDoc.data() : {};
                const saved = Array.isArray(sd.categories) ? sd.categories : Array.isArray(sd.categorias) ? sd.categorias : [];
                const snap = await db.collection('products').where('storeId','==',storeId).get();
                const fromProd = new Set();
                snap.docs.forEach(d => { const c = (d.data().category||'').trim(); if(c) fromProd.add(c); });
                categories = [...new Set([...saved,...fromProd])].filter(Boolean).sort((a,b)=>a.localeCompare(b,'pt-BR'));
                if (sd.name) document.getElementById('storeTag').textContent = sd.name;
                console.log('üìÇ Categorias:', categories, 'üÜî storeId:', storeId);
            } catch(e) { console.error('Erro categorias:', e); }
        }

        function render() {
            [1,2,3].forEach(i => {
                document.getElementById(`step${i}`).className = 'step-dot' + (i<state.step?' done':i===state.step?' active':'');
            });
            const c = document.getElementById('content');
            if (state.step===1) { c.innerHTML = renderConfig(); bindConfig(); document.getElementById('inMarca')?.focus(); }
            else if (state.step===2) { c.innerHTML = renderInput(); bindInput(); if(state.currentIndex<state.quantidade) document.getElementById('inName')?.focus(); }
        }

        // ‚îÄ‚îÄ Step 1 ‚îÄ‚îÄ
        function renderConfig() {
            const opts = categories.length
                ? '<option value="">Sem categoria</option>' + categories.map(c=>`<option value="${esc(c)}" ${state.category===c?'selected':''}>${esc(c)}</option>`).join('')
                : '<option value="">Nenhuma categoria</option>';
            return `
                <div class="card">
                    <div class="card-title">Dados do lote</div>
                    <div class="field"><label>Marca</label><input id="inMarca" value="${esc(state.marca)}" placeholder="Ex: Ziggy"></div>
                    <div class="row-2">
                        <div class="field"><label>Tipo</label><input id="inTipo" value="${esc(state.tipo)}" placeholder="Ex: Ess√™ncia"></div>
                        <div class="field"><label>Quantidade</label><input id="inQtd" type="number" min="1" max="200" value="${state.quantidade||''}" placeholder="5"></div>
                    </div>
                    <div class="field"><label>Categoria (opcional)</label><select id="inCat">${opts}</select></div>
                    <div class="price-toggle">
                        <label class="toggle"><input type="checkbox" id="chkPrice" ${state.usePrice?'checked':''}><span class="slider"></span></label>
                        <label>Pre√ßo igual para todos</label>
                    </div>
                    <div class="field" id="priceField" style="display:${state.usePrice?'block':'none'}">
                        <label>Pre√ßo (R$)</label><input id="inPrice" type="number" step="0.01" min="0" value="${state.price}" placeholder="0.00">
                    </div>
                </div>
                <div class="actions">
                    <button class="btn btn-ghost" onclick="window.close()">Cancelar</button>
                    <button class="btn btn-primary" id="btnStart">Iniciar ‚ñ∂</button>
                </div>`;
        }

        function bindConfig() {
            ['inMarca','inTipo','inQtd','inPrice'].forEach((id,i,a) => {
                const el = document.getElementById(id); if(!el) return;
                el.addEventListener('keydown', e => { if(e.key!=='Enter') return; const nx=a.slice(i+1).map(x=>document.getElementById(x)).find(x=>x&&x.offsetParent); nx?nx.focus():goStep2(); });
            });
            document.getElementById('chkPrice').addEventListener('change', e => {
                state.usePrice = e.target.checked;
                document.getElementById('priceField').style.display = state.usePrice?'block':'none';
                if(state.usePrice) document.getElementById('inPrice')?.focus();
            });
            document.getElementById('btnStart').addEventListener('click', goStep2);
        }

        function goStep2() {
            state.marca = document.getElementById('inMarca')?.value.trim()||'';
            state.tipo = document.getElementById('inTipo')?.value.trim()||'';
            state.quantidade = parseInt(document.getElementById('inQtd')?.value)||0;
            state.price = document.getElementById('inPrice')?.value||'';
            state.category = document.getElementById('inCat')?.value||'';
            if(!state.marca||!state.tipo||state.quantidade<1) { alert('Preencha Marca, Tipo e Quantidade.'); return; }
            state.step=2; state.currentIndex=0; state.items=[];
            render();
        }

        // ‚îÄ‚îÄ Step 2 ‚îÄ‚îÄ
        function renderInput() {
            const done = state.currentIndex>=state.quantidade;
            const catL = state.category ? ` ¬∑ üìÇ ${esc(state.category)}` : '';
            return `
                <div class="card" style="padding:16px 20px;">
                    <span style="font-size:.85rem;color:#a78bfa;font-weight:600;">${esc(state.marca)} ¬∑ ${esc(state.tipo)}${catL}</span>
                    <span style="float:right;font-size:.8rem;color:#888;">${Math.min(state.currentIndex,state.quantidade)} / ${state.quantidade}</span>
                </div>
                ${!done?`<div class="name-box active" id="nameBox"><div class="counter">Item ${state.currentIndex+1} de ${state.quantidade}</div><input id="inName" placeholder="Nome e Enter ‚Üµ" autocomplete="off"><div class="hint">Enter para adicionar</div></div>`:`<div class="done-banner">‚úÖ Todos preenchidos!</div>`}
                ${state.items.length?`<div class="items-header"><span id="ic">üìã ${state.items.length} ite${state.items.length===1?'m':'ns'}</span></div>`:''}
                <ul class="items-list" id="list">${renderItems()}</ul>
                <div class="actions">
                    <button class="btn btn-ghost" id="btnBack">‚Üê Voltar</button>
                    ${state.items.length?`<button class="btn btn-success" id="btnSave">Salvar ${state.items.length} produto${state.items.length>1?'s':''} ‚úì</button>`:''}
                </div>
                <div class="status-msg" id="statusMsg"></div>`;
        }

        function renderItems() {
            return state.items.map((it,i) => state.editingId===it.id
                ? `<li class="item-row"><span class="item-num">${i+1}.</span><input id="editIn" value="${esc(it.nome)}" autocomplete="off"><button class="icon-btn save" data-a="save" data-id="${it.id}">üíæ</button><button class="icon-btn del" data-a="del" data-id="${it.id}">üóëÔ∏è</button></li>`
                : `<li class="item-row"><span class="item-num">${i+1}.</span><span class="item-name">${esc(state.marca)} ${esc(state.tipo)} <strong>${esc(it.nome)}</strong></span><button class="icon-btn edit" data-a="edit" data-id="${it.id}">‚úèÔ∏è</button><button class="icon-btn del" data-a="del" data-id="${it.id}">üóëÔ∏è</button></li>`
            ).join('');
        }

        function bindInput() {
            document.getElementById('inName')?.addEventListener('keydown', e => { if(e.key==='Enter') addName(); });
            const list = document.getElementById('list');
            list?.addEventListener('click', e => { const b=e.target.closest('[data-a]'); if(!b) return; const id=+b.dataset.id; ({edit:editItem,save:saveEdit,del:delItem})[b.dataset.a]?.(id); });
            list?.addEventListener('keydown', e => { if(e.key==='Enter'&&e.target.id==='editIn') { const id=+e.target.closest('.item-row').querySelector('[data-id]').dataset.id; saveEdit(id); } });
            document.getElementById('btnBack')?.addEventListener('click', ()=>{ state.step=1; render(); });
            document.getElementById('btnSave')?.addEventListener('click', saveBatch);
        }

        function addName() {
            const input=document.getElementById('inName'); const nome=input?.value.trim(); if(!nome) return;
            idCounter++; state.items.push({id:idCounter,nome}); state.currentIndex++; input.value='';
            refreshList();
            if(state.currentIndex>=state.quantidade) { const box=document.getElementById('nameBox'); if(box) box.outerHTML='<div class="done-banner">‚úÖ Todos preenchidos!</div>'; }
            else { const c=document.querySelector('.name-box .counter'); if(c) c.textContent=`Item ${state.currentIndex+1} de ${state.quantidade}`; input?.focus(); }
            updateUI();
            const l=document.getElementById('list'); if(l) l.scrollTop=l.scrollHeight;
        }
        function editItem(id) { state.editingId=id; refreshList(); document.getElementById('editIn')?.focus(); }
        function saveEdit(id) { const v=document.getElementById('editIn')?.value.trim(); if(v){const it=state.items.find(i=>i.id===id);if(it)it.nome=v;} state.editingId=null; refreshList(); }
        function delItem(id) { state.items=state.items.filter(i=>i.id!==id); if(state.editingId===id) state.editingId=null; refreshList(); updateUI(); }
        function refreshList() { document.getElementById('list').innerHTML=renderItems(); }
        function updateUI() {
            const ic=document.getElementById('ic'); if(ic) ic.textContent=`üìã ${state.items.length} ite${state.items.length===1?'m':'ns'}`;
            let btn=document.getElementById('btnSave');
            if(!btn&&state.items.length) { const a=document.querySelector('.actions'); btn=document.createElement('button'); btn.className='btn btn-success'; btn.id='btnSave'; btn.addEventListener('click',saveBatch); a?.appendChild(btn); }
            if(btn) btn.textContent=`Salvar ${state.items.length} produto${state.items.length>1?'s':''} ‚úì`;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  SAVE ‚Äî db.collection('products').doc()
        //  Campo storeId no documento (N√ÉO subcollection)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function saveBatch() {
            if(!state.items.length) return;
            const btn=document.getElementById('btnSave'), st=document.getElementById('statusMsg');
            if(btn){btn.disabled=true;btn.textContent='Salvando...';}
            if(st){st.className='status-msg info';st.textContent='‚è≥ Gravando...';}

            try {
                const batch = db.batch();
                const now = firebase.firestore.FieldValue.serverTimestamp();
                const price = state.usePrice ? parseFloat(state.price)||0 : 0;
                const ids = [];

                state.items.forEach(item => {
                    const ref = db.collection('products').doc();  // ‚úÖ RAIZ
                    ids.push(ref.id);
                    const doc = {
                        name: `${state.marca} ${state.tipo} ${item.nome}`,
                        marca: state.marca,
                        tipo: state.tipo,
                        variante: item.nome,
                        storeId: storeId,    // ‚úÖ campo storeId
                        active: true,
                        createdAt: now,
                        updatedAt: now
                    };
                    if(price>0) doc.price = price;
                    if(state.category) doc.category = state.category;
                    batch.set(ref, doc);
                });

                await batch.commit();
                console.log(`‚úÖ ${ids.length} produtos em "products" (raiz) | storeId: ${storeId}`);
                console.log('IDs:', ids);

                // Verifica√ß√£o
                const chk = await db.collection('products').doc(ids[0]).get();
                console.log('Verifica√ß√£o:', chk.exists?'‚úÖ OK':'‚ùå N√ÉO ENCONTRADO', chk.data?.());

                if(window.opener) window.opener.postMessage({type:'productSaved'},'*');

                state.step=3;
                [1,2,3].forEach(i=>document.getElementById(`step${i}`).className='step-dot done');
                document.getElementById('content').innerHTML = `
                    <div class="card" style="text-align:center;padding:40px 24px;">
                        <div style="font-size:3rem;margin-bottom:16px;">‚úÖ</div>
                        <div style="font-size:1.1rem;font-weight:600;color:#34d399;margin-bottom:8px;">${state.items.length} produto${state.items.length>1?'s':''} criado${state.items.length>1?'s':''}!</div>
                        <div style="font-size:.85rem;color:#888;margin-bottom:6px;">${esc(state.marca)} ${esc(state.tipo)}${state.category?' ¬∑ üìÇ '+esc(state.category):''}</div>
                        <div style="font-size:.8rem;color:#666;margin-bottom:24px;">${state.items.map(i=>i.nome).join(', ')}</div>
                        <div class="actions" style="justify-content:center;">
                            <button class="btn btn-primary" onclick="location.reload()">Novo Lote</button>
                            <button class="btn btn-ghost" onclick="window.close()">Fechar</button>
                        </div>
                    </div>`;
            } catch(err) {
                console.error('‚ùå',err);
                if(st){st.className='status-msg error';st.textContent='‚ùå '+err.message;}
                if(btn){btn.disabled=false;btn.textContent=`Salvar ${state.items.length} produto${state.items.length>1?'s':''} ‚úì`;}
            }
        }

        function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

        (async()=>{ await loadCategories(); render(); })();
    })();
    </script>
</body>
</html>
